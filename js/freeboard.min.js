function DialogBox(n,t,i,r,u){function s(){f.fadeOut(200,function(){$(this).remove()})}var f=$('<div id="modal_overlay" style="display:none;"><\/div>'),e=$('<div class="modal"><\/div>'),o;e.append('<header><h2 class="title">'+t+"<\/h2><\/header>");$("<section><\/section>").appendTo(e).append(n);o=$("<footer><\/footer>").appendTo(e);i&&$('<span id="dialog-ok" class="text-button">'+i+"<\/span>").appendTo(o).click(function(){var n=!1;_.isFunction(u)&&(n=u());n||s()});r&&$('<span id="dialog-cancel" class="text-button">'+r+"<\/span>").appendTo(o).click(function(){s()});f.append(e);$("body").append(f);f.fadeIn(200)}function FreeboardModel(n,t,i){var r=this,u=1;this.version=0;this.isEditing=ko.observable(!1);this.allow_edit=ko.observable(!1);this.allow_edit.subscribe(function(n){n?$("#main-header").show():$("#main-header").hide()});this.header_image=ko.observable();this.plugins=ko.observableArray();this.datasources=ko.observableArray();this.panes=ko.observableArray();this.datasourceData={};this.processDatasourceUpdate=function(n,t){var i=n.name();r.datasourceData[i]=t;_.each(r.panes(),function(n){_.each(n.widgets(),function(n){n.processDatasourceUpdate(i)})})};this._datasourceTypes=ko.observable();this.datasourceTypes=ko.computed({read:function(){r._datasourceTypes();var t=[];return _.each(n,function(n){var i=n.type_name,r=i;_.isUndefined(n.display_name)||(r=n.display_name);t.push({name:i,display_name:r})}),t}});this._widgetTypes=ko.observable();this.widgetTypes=ko.computed({read:function(){r._widgetTypes();var n=[];return _.each(t,function(t){var i=t.type_name,r=i;_.isUndefined(t.display_name)||(r=t.display_name);n.push({name:i,display_name:r})}),n}});this.addPluginSource=function(n){n&&r.plugins.indexOf(n)==-1&&r.plugins.push(n)};this.serialize=function(){var t=[],n;return _.each(r.panes(),function(n){t.push(n.serialize())}),n=[],_.each(r.datasources(),function(t){n.push(t.serialize())}),{version:u,header_image:r.header_image(),allow_edit:r.allow_edit(),plugins:r.plugins(),panes:t,datasources:n,columns:i.getUserColumns()}};this.deserialize=function(u,f){function e(){i.setUserColumns(u.columns);_.isUndefined(u.allow_edit)?r.allow_edit(!0):r.allow_edit(u.allow_edit);r.version=u.version||0;r.header_image(u.header_image);_.each(u.datasources,function(t){var i=new DatasourceModel(r,n);i.deserialize(t);r.addDatasource(i)});var e=_.sortBy(u.panes,function(n){return i.getPositionForScreenSize(n).row});_.each(e,function(n){var i=new PaneModel(r,t);i.deserialize(n);r.panes.push(i)});r.allow_edit()&&r.panes().length==0&&r.setEditing(!0);_.isFunction(f)&&f();i.processResize(!0)}r.clearDashboard();_.each(u.plugins,function(n){r.addPluginSource(n)});_.isArray(u.plugins)&&u.plugins.length>0?head.js(u.plugins,function(){e()}):e()};this.clearDashboard=function(){i.removeAllPanes();_.each(r.datasources(),function(n){n.dispose()});_.each(r.panes(),function(n){n.dispose()});r.plugins.removeAll();r.datasources.removeAll();r.panes.removeAll()};this.loadDashboard=function(n,t){i.showLoadingIndicator(!0);r.deserialize(n,function(){i.showLoadingIndicator(!1);_.isFunction(t)&&t();freeboard.emit("dashboard_loaded")})};this.loadDashboardFromLocalFile=function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var n=document.createElement("input");n.type="file";$(n).on("change",function(n){var t=n.target.files,u,i;t&&t.length>0&&(u=t[0],i=new FileReader,i.addEventListener("load",function(n){var t=n.target,i=JSON.parse(t.result);r.loadDashboard(i);r.setEditing(!1)}),i.readAsText(u))});$(n).trigger("click")}else alert("Unable to load a file in this browser.")};this.saveDashboard=function(){var n=document.createElement("a"),t=new Blob([JSON.stringify(r.serialize())],{type:"application/octet-stream"});document.body.appendChild(n);n.href=window.URL.createObjectURL(t);n.download="dashboard.json";n.target="_self";n.click()};this.addDatasource=function(n){r.datasources.push(n)};this.deleteDatasource=function(n){delete r.datasourceData[n.name()];n.dispose();r.datasources.remove(n)};this.createPane=function(){var n=new PaneModel(r,t);r.addPane(n)};this.addGridColumnLeft=function(){i.addGridColumnLeft()};this.addGridColumnRight=function(){i.addGridColumnRight()};this.subGridColumnLeft=function(){i.subGridColumnLeft()};this.subGridColumnRight=function(){i.subGridColumnRight()};this.addPane=function(n){r.panes.push(n)};this.deletePane=function(n){n.dispose();r.panes.remove(n)};this.deleteWidget=function(n){ko.utils.arrayForEach(r.panes(),function(t){t.widgets.remove(n)});n.dispose()};this.setEditing=function(n,t){if(r.allow_edit()||!n){r.isEditing(n);_.isUndefined(t)&&(t=!0);var u=t?250:0,f=$("#admin-bar").outerHeight();n?($("#toggle-header-icon").addClass("icon-chevron-up").removeClass("icon-wrench"),$(".gridster .gs_w").css({cursor:"pointer"}),$("#main-header").animate({top:"0px"},u),$("#board-content").animate({top:f+20+"px"},u),$("#main-header").data().shown=!0,i.attachWidgetEditIcons($(".sub-section")),i.enableGrid()):($("#toggle-header-icon").addClass("icon-wrench").removeClass("icon-chevron-up"),$(".gridster .gs_w").css({cursor:"default"}),$("#main-header").animate({top:"-"+f+"px"},u),$("#board-content").animate({top:"20"},u),$("#main-header").data().shown=!1,$(".sub-section").unbind(),i.disableGrid());i.showPaneEditIcons(n,t)}};this.toggleEditing=function(){var n=!r.isEditing();r.setEditing(n)}}function FreeboardUI(){function a(t){var i=p(),u=function(){};t&&(u=function(){var r=this,t=ko.dataFor(r),u=c(t);$(r).attr("data-sizex",Math.min(t.col_width(),i,n.cols)).attr("data-row",u.row).attr("data-col",u.col);t.processSizeChange()});o(Math.min(i,r));s(u);e()}function v(t){var i=n.cols+1;o(i)&&s(function(){var f=this,r=ko.dataFor(f),e=n.cols>1?n.cols-1:1,u=r.col[e],o=r.row[e],i,s;t?(leftPreviewCol=!0,s=u<n.cols?u+1:n.cols,i={row:o,col:s}):(rightPreviewCol=!0,i={row:o,col:u});$(f).attr("data-sizex",Math.min(r.col_width(),n.cols)).attr("data-row",i.row).attr("data-col",i.col)});e();r=n.cols}function y(t){var i=n.cols-1;o(i)&&s(function(){var e=this,f=ko.dataFor(e),o=n.cols+1,i=f.col[o],s=f.row[o],r,u;t?(u=i>1?i-1:1,r={row:s,col:u}):(u=i<=n.cols?i:n.cols,r={row:s,col:u});$(e).attr("data-sizex",Math.min(f.col_width(),n.cols)).attr("data-row",r.row).attr("data-col",r.col)});e();r=n.cols}function e(){var t=$(".column-tool"),r=$("#board-content").width(),u=Math.floor(r/f);n.cols<=i?t.addClass("min"):t.removeClass("min");n.cols>=u?t.addClass("max"):t.removeClass("max")}function p(){var n=$("#board-content").width();return Math.floor(n/f)}function o(t){var r,u;return(t===undefined||t<i)&&(t=i),r=p(),t>r&&(t=r),u=f*t+t,$(".responsive-column-width").css("max-width",u),t===n.cols?!1:!0}function s(i){var r=n.$el;r.find("> li").unbind().removeData();$(".responsive-column-width").css("width","");n.generate_grid_and_stylesheet();r.find("> li").each(i);n.init();$(".responsive-column-width").css("width",n.cols*u+n.cols*t*2)}function k(){return r}function d(n){r=Math.max(i,n)}function g(t,i,r){var u=c(i),f=u.col,e=u.row,o=Number(i.width()),s=Number(i.getCalculatedHeight());n.add_widget(t,o,s,f,e);r&&w(!0);h(i,e,f);$(t).attrchange({trackValues:!0,callback:function(n){n.attributeName=="data-row"?h(i,Number(n.newValue),undefined):n.attributeName=="data-col"&&h(i,undefined,Number(n.newValue))}})}function nt(t,i){var r=i.getCalculatedHeight(),u=Number($(t).attr("data-sizey")),f=Number($(t).attr("data-sizex"));(r!=u||i.col_width()!=f)&&n.resize_widget($(t),i.col_width(),r,function(){n.set_dom_grid_height()})}function h(t,i,r){var u=n.cols;_.isUndefined(i)||(t.row[u]=i);_.isUndefined(r)||(t.col[u]=r)}function tt(n){n?l.fadeOut(0).appendTo("body").fadeIn(500):l.fadeOut(500).remove()}function w(n,t){_.isUndefined(t)&&(t=!0);var i=t?250:0;n?($(".pane-tools").fadeIn(i),$("#column-tools").fadeIn(i)):($(".pane-tools").fadeOut(i),$("#column-tools").fadeOut(i))}function it(n){$(n).hover(function(){b(this,!0)},function(){b(this,!1)})}function b(n,t){t?$(n).find(".sub-section-tools").fadeIn(250):$(n).find(".sub-section-tools").fadeOut(250)}function c(t){var u=n.cols,f,i,e,r,o;_.isNumber(t.row)&&_.isNumber(t.col)&&(f={},f[u]=t.row,t.row=f,f={},f[u]=t.col,t.col=f);i=1;e=1e3;for(r in t.col){if(r==u)return{row:t.row[r],col:t.col[r]};t.col[r]>u?i=u:(o=u-r,o<e&&(i=r,e=o))}return i in t.col&&i in t.row?{row:t.row[i],col:t.col[i]}:{row:1,col:i}}var t=10,u=300,i=3,f=t+u+t,r=i,l=$('<div class="wrapperloading"><div class="loading up" ><\/div><div class="loading down"><\/div><\/div>'),n;return ko.bindingHandlers.grid={init:function(i){n=$(i).gridster({widget_margins:[t,t],widget_base_dimensions:[u,10],resize:{enabled:!1,axes:"x"}}).data("gridster");a(!1);n.disable()}},{showLoadingIndicator:function(n){tt(n)},showPaneEditIcons:function(n,t){w(n,t)},attachWidgetEditIcons:function(n){it(n)},getPositionForScreenSize:function(n){return c(n)},processResize:function(n){a(n)},disableGrid:function(){n.disable()},enableGrid:function(){n.enable()},addPane:function(n,t,i){g(n,t,i)},updatePane:function(n,t){nt(n,t)},removePane:function(t){n.remove_widget(t)},removeAllPanes:function(){n.remove_all_widgets()},addGridColumnLeft:function(){v(!0)},addGridColumnRight:function(){v(!1)},subGridColumnLeft:function(){y(!0)},subGridColumnRight:function(){y(!1)},getUserColumns:function(){return k()},setUserColumns:function(n){d(n)}}}function PaneModel(n,t){var i=this;this.title=ko.observable();this.width=ko.observable(1);this.row={};this.col={};this.col_width=ko.observable(1);this.col_width.subscribe(function(){i.processSizeChange()});this.widgets=ko.observableArray();this.addWidget=function(n){this.widgets.push(n)};this.widgetCanMoveUp=function(n){return i.widgets.indexOf(n)>=1};this.widgetCanMoveDown=function(n){var t=i.widgets.indexOf(n);return t<i.widgets().length-1};this.moveWidgetUp=function(n){if(i.widgetCanMoveUp(n)){var t=i.widgets.indexOf(n),r=i.widgets();i.widgets.splice(t-1,2,r[t],r[t-1])}};this.moveWidgetDown=function(n){if(i.widgetCanMoveDown(n)){var t=i.widgets.indexOf(n),r=i.widgets();i.widgets.splice(t,2,r[t+1],r[t])}};this.processSizeChange=function(){setTimeout(function(){_.each(i.widgets(),function(n){n.processSizeChange()})},1e3)};this.getCalculatedHeight=function(){var n=_.reduce(i.widgets(),function(n,t){return n+t.height()},0),t;return n*=6,n+=3,n*=10,t=Math.ceil((n+20)/30),Math.max(4,t)};this.serialize=function(){var n=[];return _.each(i.widgets(),function(t){n.push(t.serialize())}),{title:i.title(),width:i.width(),row:i.row,col:i.col,col_width:i.col_width(),widgets:n}};this.deserialize=function(r){i.title(r.title);i.width(r.width);i.row=r.row;i.col=r.col;i.col_width(r.col_width||1);_.each(r.widgets,function(r){var u=new WidgetModel(n,t);u.deserialize(r);i.widgets.push(u)})};this.dispose=function(){_.each(i.widgets(),function(n){n.dispose()})}}function WidgetModel(n,t){function r(){_.isUndefined(i.widgetInstance)||(_.isFunction(i.widgetInstance.onDispose)&&i.widgetInstance.onDispose(),i.widgetInstance=undefined)}var i=this;this.datasourceRefreshNotifications={};this.calculatedSettingScripts={};this.title=ko.observable();this.fillSize=ko.observable(!1);this.type=ko.observable();this.type.subscribe(function(n){if(r(),n in t&&_.isFunction(t[n].newInstance)){var u=t[n];function f(){u.newInstance(i.settings(),function(n){i.fillSize(u.fill_size===!0);i.widgetInstance=n;i.shouldRender(!0);i._heightUpdate.valueHasMutated()})}u.external_scripts?head.js(u.external_scripts.slice(0),f):f()}});this.settings=ko.observable({});this.settings.subscribe(function(n){if(!_.isUndefined(i.widgetInstance)&&_.isFunction(i.widgetInstance.onSettingsChanged))i.widgetInstance.onSettingsChanged(n);i.updateCalculatedSettings();i._heightUpdate.valueHasMutated()});this.processDatasourceUpdate=function(n){var t=i.datasourceRefreshNotifications[n];_.isArray(t)&&_.each(t,function(n){i.processCalculatedSetting(n)})};this.callValueFunction=function(t){return t.call(undefined,n.datasourceData)};this.processSizeChange=function(){!_.isUndefined(i.widgetInstance)&&_.isFunction(i.widgetInstance.onSizeChanged)&&i.widgetInstance.onSizeChanged()};this.processCalculatedSetting=function(n){var t,r;if(_.isFunction(i.calculatedSettingScripts[n])){t=undefined;try{t=i.callValueFunction(i.calculatedSettingScripts[n])}catch(u){r=i.settings()[n];u instanceof ReferenceError&&/^\w+$/.test(r)&&(t=r)}if(!_.isUndefined(i.widgetInstance)&&_.isFunction(i.widgetInstance.onCalculatedValueChanged)&&!_.isUndefined(t))try{i.widgetInstance.onCalculatedValueChanged(n,t)}catch(u){console.log(u.toString())}}};this.updateCalculatedSettings=function(){if(i.datasourceRefreshNotifications={},i.calculatedSettingScripts={},!_.isUndefined(i.type())){var r=t[i.type()].settings,u=new RegExp("datasources.([\\w_-]+)|datasources\\[['\"]([^'\"]+)","g"),n=i.settings();_.each(r,function(t){var r,e,h,o,s,f;if(t.type=="calculated"&&(r=n[t.name],!_.isUndefined(r))){_.isArray(r)&&(r="["+r.join(",")+"]");(r.match(/;/g)||[]).length<=1&&r.indexOf("return")==-1&&(r="return "+r);try{e=new Function("datasources",r)}catch(c){h=n[t.name].replace(/"/g,'\\"').replace(/[\r\n]/g," \\\n");e=new Function("datasources",'return "'+h+'";')}for(i.calculatedSettingScripts[t.name]=e,i.processCalculatedSetting(t.name);o=u.exec(r);)s=o[1]||o[2],f=i.datasourceRefreshNotifications[s],_.isUndefined(f)&&(f=[],i.datasourceRefreshNotifications[s]=f),_.indexOf(f,t.name)==-1&&f.push(t.name)}})}};this._heightUpdate=ko.observable();this.height=ko.computed({read:function(){return(i._heightUpdate(),!_.isUndefined(i.widgetInstance)&&_.isFunction(i.widgetInstance.getHeight))?i.widgetInstance.getHeight():1}});this.shouldRender=ko.observable(!1);this.render=function(n){i.shouldRender(!1);!_.isUndefined(i.widgetInstance)&&_.isFunction(i.widgetInstance.render)&&(i.widgetInstance.render(n),i.updateCalculatedSettings())};this.dispose=function(){};this.serialize=function(){return{title:i.title(),type:i.type(),settings:i.settings()}};this.deserialize=function(n){i.title(n.title);i.settings(n.settings);i.type(n.type)}}DatasourceModel=function(n,t){function r(){_.isUndefined(i.datasourceInstance)||(_.isFunction(i.datasourceInstance.onDispose)&&i.datasourceInstance.onDispose(),i.datasourceInstance=undefined)}var i=this;this.name=ko.observable();this.latestData=ko.observable();this.settings=ko.observable({});this.settings.subscribe(function(n){if(!_.isUndefined(i.datasourceInstance)&&_.isFunction(i.datasourceInstance.onSettingsChanged))i.datasourceInstance.onSettingsChanged(n)});this.updateCallback=function(t){n.processDatasourceUpdate(i,t);i.latestData(t);var r=new Date;i.last_updated(r.toLocaleTimeString())};this.type=ko.observable();this.type.subscribe(function(n){if(r(),n in t&&_.isFunction(t[n].newInstance)){var u=t[n];function f(){u.newInstance(i.settings(),function(n){i.datasourceInstance=n;n.updateNow()},i.updateCallback)}u.external_scripts?head.js(u.external_scripts.slice(0),f):f()}});this.last_updated=ko.observable("never");this.last_error=ko.observable();this.serialize=function(){return{name:i.name(),type:i.type(),settings:i.settings()}};this.deserialize=function(n){i.settings(n.settings);i.name(n.name);i.type(n.type)};this.getDataRepresentation=function(n){var t=new Function("data","return "+n+";");return t.call(undefined,i.latestData())};this.updateNow=function(){!_.isUndefined(i.datasourceInstance)&&_.isFunction(i.datasourceInstance.updateNow)&&i.datasourceInstance.updateNow()};this.dispose=function(){r()}};DeveloperConsole=function(n){function t(){function e(n){var u=$("<tr><\/tr>"),f=$('<ul class="board-toolbar"><\/ul>'),i=$('<input class="table-row-value" style="width:100%;" type="text">'),e=$('<li><i class="icon-trash icon-white"><\/i><\/li>').click(function(){t=_.without(t,i);u.remove()});t.push(i);n&&i.val(n);f.append(e);r.append(u.append($("<td><\/td>").append(i)).append($('<td class="table-row-operation">').append(f)))}var t=[],u=$("<div><\/div>"),f=$('<div class="table-operation text-button">ADD<\/div>'),i=$('<table class="table table-condensed sub-table"><\/table>'),r;i.append($('<thead style=""><tr><th>Plugin Script URL<\/th><\/tr><\/thead>'));r=$("<tbody><\/tbody>");i.append(r);u.append($("<p>Here you can add references to other scripts to load datasource or widget plugins.<\/p>")).append(i).append(f).append('<p>To learn how to build plugins for freeboard, please visit <a target="_blank" href="http://freeboard.github.io/freeboard/docs/plugin_example.html">http://freeboard.github.io/freeboard/docs/plugin_example.html<\/a><\/p>');_.each(n.plugins(),function(n){e(n)});f.click(function(){e()});new DialogBox(u,"Developer Console","OK",null,function(){_.each(n.plugins(),function(n){$('script[src^="'+n+'"]').remove()});n.plugins.removeAll();_.each(t,function(t){var i=t.val();i&&i.length>0&&(n.addPluginSource(i),head.js(i+"?"+Date.now()))})})}return{showDeveloperConsole:function(){t()}}};JSEditor=function(){function t(t){n=t}function i(n,t){var r='// Example: Convert temp from C to F and truncate to 2 decimal places.\n// return (datasources["MyDatasource"].sensor.tempInF * 1.8 + 32).toFixed(2);',e,o;n||(n=r);var i=$('<div class="code-window"><\/div>'),u=$('<div class="code-mirror-wrapper"><\/div>'),f=$('<div class="code-window-footer"><\/div>'),s=$('<div class="code-window-header cm-s-ambiance">This javascript will be re-evaluated any time a datasource referenced here is updated, and the value you <code><span class="cm-keyword">return<\/span><\/code> will be displayed in the widget. You can assume this javascript is wrapped in a function of the form <code><span class="cm-keyword">function<\/span>(<span class="cm-def">datasources<\/span>)<\/code> where datasources is a collection of javascript objects (keyed by their name) corresponding to the most current data in a datasource.<\/div>');i.append([s,u,f]);$("body").append(i);e=CodeMirror(u.get(0),{value:n,mode:"javascript",theme:"ambiance",indentUnit:4,lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0});o=$('<span id="dialog-cancel" class="text-button">Close<\/span>').click(function(){if(t){var n=e.getValue();n===r&&(n="");t(n);i.remove()}});f.append(o)}var n="";return{displayJSEditor:function(n,t){i(n,t)},setAssetRoot:function(n){t(n)}}};PluginEditor=function(n,t){function r(n,t){var i=$('<div class="validation-error"><\/div>').html(t);$("#setting-value-container-"+n).append(i)}function u(){$("#setting-row-instance-name").length?$("#setting-row-instance-name").nextAll().remove():$("#setting-row-plugin-types").nextAll().remove()}function f(n){return!isNaN(parseFloat(n))&&isFinite(n)}function i(i,r,u,f,e){var o=$("<textarea><\/textarea>"),s,h,c,l,a;u.multi_input?o.change(function(){var n=[];$(i).find("textarea").each(function(){var t=$(this).val();t&&(n=n.concat(t))});r.settings[u.name]=n}):o.change(function(){r.settings[u.name]=$(this).val()});f&&o.val(f);t.createValueEditor(o);s=$('<ul class="board-toolbar datasource-input-suffix"><\/ul>');h=$('<div class="calculated-setting-row"><\/div>');h.append(o).append(s);c=$('<li><i class="icon-plus icon-white"><\/i><label>DATASOURCE<\/label><\/li>').mousedown(function(n){n.preventDefault();$(o).val("").focus().insertAtCaret('datasources["').trigger("freeboard-eval")});s.append(c);l=$('<li><i class="icon-fullscreen icon-white"><\/i><label>.JS EDITOR<\/label><\/li>').mousedown(function(t){t.preventDefault();n.displayJSEditor(o.val(),function(n){o.val(n);o.change()})});s.append(l);e&&(a=$('<li class="remove-setting-row"><i class="icon-minus icon-white"><\/i><label><\/label><\/li>').mousedown(function(n){n.preventDefault();h.remove();$(i).find("textarea:first").change()}),s.prepend(a));$(i).append(h)}function e(n,t,e,o,s){function p(n,t){var i=$('<div id="setting-row-'+n+'" class="form-row"><\/div>').appendTo(v);return i.append('<div class="form-label"><label class="control-label">'+t+"<\/label><\/div>"),$('<div id="setting-value-container-'+n+'" class="form-value"><\/div>').appendTo(i)}function w(n,t,r){_.each(n,function(n){var a,f,nt,s,e,w,c,tt,u,l;!_.isUndefined(n.default_value)&&_.isUndefined(o[n.name])&&(o[n.name]=n.default_value);a=n.name;_.isUndefined(n.display_name)||(a=n.display_name);f=p(n.name,a);switch(n.type){case"array":{var v=$('<div class="form-table-value-subtable"><\/div>').appendTo(f),b=$('<table class="table table-condensed sub-table"><\/table>').appendTo(v),y=$("<thead><\/thead>").hide().appendTo(b),it=$("<tr><\/tr>").appendTo(y),rt=$("<tbody><\/tbody>").appendTo(b),k=[];_.each(n.settings,function(n){var t=n.name;_.isUndefined(n.display_name)||(t=n.display_name);$("<th>"+t+"<\/th>").appendTo(it)});n.name in o&&(k=o[n.name]);function d(){h.settings[n.name].length>0?y.show():y.hide()}function g(t){var r=$("<tr><\/tr>").appendTo(rt),i={};_.isArray(h.settings[n.name])||(h.settings[n.name]=[]);h.settings[n.name].push(i);_.each(n.settings,function(n){var f=$("<td><\/td>").appendTo(r),u="";_.isUndefined(t[n.name])||(u=t[n.name]);i[n.name]=u;$('<input class="table-row-value" type="text">').appendTo(f).val(u).change(function(){i[n.name]=$(this).val()})});r.append($('<td class="table-row-operation"><\/td>').append($('<ul class="board-toolbar"><\/ul>').append($("<li><\/li>").append($('<i class="icon-trash icon-white"><\/i>').click(function(){var t=h.settings[n.name].indexOf(i);t!=-1&&(h.settings[n.name].splice(t,1),r.remove(),d())})))));v.scrollTop(v[0].scrollHeight);d()}$('<div class="table-operation text-button">ADD<\/div>').appendTo(f).click(function(){var t={};_.each(n.settings,function(n){t[n.name]=""});g(t)});_.each(k,function(n){g(n)});break}case"boolean":h.settings[n.name]=o[n.name];nt=$('<div class="onoffswitch"><label class="onoffswitch-label" for="'+n.name+'-onoff"><div class="onoffswitch-inner"><span class="on">YES<\/span><span class="off">NO<\/span><\/div><div class="onoffswitch-switch"><\/div><\/label><\/div>').appendTo(f);u=$('<input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="'+n.name+'-onoff">').prependTo(nt).change(function(){h.settings[n.name]=this.checked});n.name in o&&u.prop("checked",o[n.name]);break;case"option":s=o[n.name];u=$("<select><\/select>").appendTo($('<div class="styled-select"><\/div>').appendTo(f)).change(function(){h.settings[n.name]=$(this).val()});_.each(n.options,function(n){var i,t;_.isObject(n)?(i=n.name,t=n.value):i=n;_.isUndefined(t)&&(t=i);_.isUndefined(s)&&(s=t);$("<option><\/option>").text(i).attr("value",t).appendTo(u)});h.settings[n.name]=s;n.name in o&&u.val(o[n.name]);break;default:if(h.settings[n.name]=o[n.name],n.type=="calculated"){if(n.name in o)if(e=o[n.name],n.multi_input&&_.isArray(e))for(w=!1,c=0;c<e.length;c++)i(f,h,n,e[c],w),w=!0;else i(f,h,n,e,!1);else i(f,h,n,null,!1);n.multi_input&&(tt=$('<ul class="board-toolbar"><li class="add-setting-row"><i class="icon-plus icon-white"><\/i><label>ADD<\/label><\/li><\/ul>').mousedown(function(t){t.preventDefault();i(f,h,n,null,!0)}),$(f).siblings(".form-label").append(tt))}else u=$('<input type="text">').appendTo(f).change(function(){h.settings[n.name]=n.type=="number"?Number($(this).val()):$(this).val()}),n.name in o&&u.val(o[n.name]),t&&n.typeahead_data_field&&u.addClass("typeahead_data_field-"+n.typeahead_data_field),t&&n.typeahead_field&&(l=[],u.keyup(function(n){n.which>=65&&n.which<=91&&u.trigger("change")}),$(u).autocomplete({source:l,select:function(n,t){u.val(t.item.value);u.trigger("change")}}),u.change(function(){var i=u.val(),f=_.template(t)({input:i});$.get(f,function(t){var e,f;if(r&&(t=t[r]),t=_.select(t,function(t){return t[n.typeahead_field][0]==i[0]}),l=_.map(t,function(t){return t[n.typeahead_field]}),$(u).autocomplete("option","source",l),t.length==1){t=t[0];for(e in t)t.hasOwnProperty(e)&&(f=$(_.template("input.typeahead_data_field-<%= field %>")({field:e})),f&&(f.val(t[e]),f.val()!=u.val()&&f.trigger("change")))}})}))}_.isUndefined(n.suffix)||f.append($('<div class="input-suffix">'+n.suffix+"<\/div>"));_.isUndefined(n.description)||f.append($('<div class="setting-description">'+n.description+"<\/div>"))})}var h={type:e,settings:{}},c,v=$("<div><\/div>"),y=$('<div id="plugin-description"><\/div>').hide(),a,l,b;v.append(y);new DialogBox(v,n,"Save","Cancel",function(){var t,n;for($(".validation-error").remove(),t=0;t<c.settings.length;t++){if(n=c.settings[t],n.required&&(_.isUndefined(h.settings[n.name])||h.settings[n.name]==""))return r(n.name,"This is required."),!0;if(n.type=="integer"&&h.settings[n.name]%1!=0)return r(n.name,"Must be a whole number."),!0;if(n.type=="number"&&!f(h.settings[n.name]))return r(n.name,"Must be a number."),!0}_.isFunction(s)&&s(h)});a=_.keys(t);a.length>1?(b=p("plugin-types","Type"),l=$("<select><\/select>").appendTo($('<div class="styled-select"><\/div>').appendTo(b)),l.append($("<option>Select a type...<\/option>").attr("value","undefined")),_.each(t,function(n){l.append($("<option><\/option>").text(n.display_name).attr("value",n.type_name))}),l.change(function(){h.type=$(this).val();h.settings={};u();c=t[l.val()];_.isUndefined(c)?($("#setting-row-instance-name").hide(),$("#dialog-ok").hide()):($("#setting-row-instance-name").show(),c.description&&c.description.length>0?y.html(c.description).show():y.hide(),$("#dialog-ok").show(),w(c.settings,c.typeahead_source,c.typeahead_data_segment))})):a.length==1&&(c=t[a[0]],h.type=c.type_name,h.settings={},w(c.settings));l&&(_.isUndefined(e)?($("#setting-row-instance-name").hide(),$("#dialog-ok").hide()):($("#dialog-ok").show(),l.val(e).trigger("change")))}return{createPluginEditor:function(n,t,i,r,u,f){e(n,t,i,r,u,f)}}};ValueEditor=function(n){function e(n,t){return _.isArray(n)||_.isObject(n)?!0:o(n,t)}function o(n,t){switch(t){case r.ANY:return!0;case r.ARRAY:return _.isArray(n);case r.OBJECT:return _.isObject(n);case r.STRING:return _.isString(n);case r.NUMBER:return _.isNumber(n);case r.BOOLEAN:return _.isBoolean(n)}}function s(n,t){$(n).parent().find(".validation-error").remove();o(f,t)||$(n).parent().append("<div class='validation-error'>This field expects an expression that evaluates to type "+t+".<\/div>")}function l(n){var t=($(n).val().match(/\n/g)||[]).length,i=Math.min(200,20*(t+1));$(n).css({height:i+"px"})}function a(n,t,i){var r=c.exec(n),l=[],y,p,a,o,w,s,h,v;if(r)if(r[1]=="")_.each(t,function(n){l.push({value:n.name(),entity:undefined,precede_char:"",follow_char:'"]'})});else if(r[1]!=""&&_.isUndefined(r[2]))y=r[1],_.each(t,function(n){var t=n.name();t!=y&&t.indexOf(y)==0&&l.push({value:t,entity:undefined,precede_char:"",follow_char:'"]'})});else if(p=_.find(t,function(n){return n.name()===r[1]}),!_.isUndefined(p))if(a="data",o="",_.isUndefined(r[2])||(w=r[3].lastIndexOf("]")+1,a=a+r[3].substring(0,w),o=r[3].substring(w,r[3].length),o=o.replace(/^[\[\"]*/,""),o=o.replace(/[\"\]]*$/,"")),s=p.getDataRepresentation(a),f=s,_.isArray(s))for(h=0;h<s.length;h++)h.toString().indexOf(o)==0&&(v=s[h],e(v,i)&&l.push({value:h,entity:v,precede_char:"[",follow_char:"]",preview:v.toString()}));else _.isObject(s)&&_.each(s,function(n,t){t.indexOf(o)==0&&e(n,i)&&l.push({value:t,entity:n,precede_char:'["',follow_char:'"]'})});u=l}function v(r,f){var e=$(r).val().substring(0,$(r).getCaretPosition()),o;e=e.replace(String.fromCharCode(160)," ");a(e,n.datasources(),f);u.length>0?(i||(i=$('<ul id="value-selector" class="value-dropdown"><\/ul>').insertAfter(r).width($(r).outerWidth()-2).css("left",$(r).position().left).css("top",$(r).position().top+$(r).outerHeight()-1)),i.empty(),i.scrollTop(0),o=!0,t=0,_.each(u,function(n,t){var i=y(r,e,n,t);o&&($(i).addClass("selected"),o=!1)})):(s(r,f),$(r).next("ul#value-selector").remove(),i=null,t=-1)}function y(n,r,u,e){var o=u.value;return u.preview&&(o=o+"<span class='preview'>"+u.preview+"<\/span>"),$("<li>"+o+"<\/li>").appendTo(i).mouseenter(function(){$(this).trigger("freeboard-select")}).mousedown(function(n){$(this).trigger("freeboard-insertValue");n.preventDefault()}).data("freeboard-optionIndex",e).data("freeboard-optionValue",u.value).bind("freeboard-insertValue",function(){var t=u.value,i;t=u.precede_char+t+u.follow_char;i=r.lastIndexOf("]");i!=-1?$(n).replaceTextAt(i+1,$(n).val().length,t):$(n).insertAtCaret(t);f=u.entity;$(n).triggerHandler("mouseup")}).bind("freeboard-select",function(){$(this).parent().find("li.selected").removeClass("selected");$(this).addClass("selected");t=$(this).data("freeboard-optionIndex")})}function h(n,r){$(n).addClass("calculated-value-input").bind("keyup mouseup freeboard-eval",function(t){if(i&&t.type=="keyup"&&(t.keyCode==38||t.keyCode==40||t.keyCode==13)){t.preventDefault();return}v(n,r)}).focus(function(){$(n).css({"z-index":3001});l(n)}).focusout(function(){s(n,r);$(n).css({height:"","z-index":3e3});$(n).next("ul#value-selector").remove();i=null;t=-1}).bind("keydown",function(n){var r,u;i&&(n.keyCode==38||n.keyCode==40?(n.preventDefault(),r=$(i).find("li"),n.keyCode==38?t--:n.keyCode==40&&t++,t<0?t=r.size()-1:t>=r.size()&&(t=0),u=$(r).eq(t),u.trigger("freeboard-select"),$(i).scrollTop($(u).position().top)):n.keyCode==13&&(n.preventDefault(),t!=-1&&$(i).find("li").eq(t).trigger("freeboard-insertValue")))})}var c=new RegExp('.*datasources\\["([^"]*)("\\])?(.*)$'),i=null,t=0,u=[],f=null,r={ANY:"any",ARRAY:"array",OBJECT:"object",STRING:"string",NUMBER:"number",BOOLEAN:"boolean"};return{createValueEditor:function(n,t){t?h(n,t):h(n,r.ANY)},EXPECTED_TYPE:r}},function(n){function i(){var n=document.createElement("p"),t=!1;if(n.addEventListener)n.addEventListener("DOMAttrModified",function(){t=!0},!1);else if(n.attachEvent)n.attachEvent("onDOMAttrModified",function(){t=!0});else return!1;return n.setAttribute("id","target"),t}function r(t,i){var r,u;t&&(r=this.data("attr-old-value"),i.attributeName.indexOf("style")>=0?(r.style||(r.style={}),u=i.attributeName.split("."),i.attributeName=u[0],i.oldValue=r.style[u[1]],i.newValue=u[1]+":"+this.prop("style")[n.camelCase(u[1])],r.style[u[1]]=i.newValue):(i.oldValue=r[i.attributeName],i.newValue=this.attr(i.attributeName),r[i.attributeName]=i.newValue),this.data("attr-old-value",r))}var t=window.MutationObserver||window.WebKitMutationObserver;n.fn.attrchange=function(u){var f={trackValues:!1,callback:n.noop},e,o;return(typeof u=="function"?f.callback=u:n.extend(f,u),f.trackValues&&n(this).each(function(t,i){for(var u={},r,t=0,f=i.attributes,e=f.length;t<e;t++)r=f.item(t),u[r.nodeName]=r.value;n(this).data("attr-old-value",u)}),t)?(e={subtree:!1,attributes:!0,attributeOldValue:f.trackValues},o=new t(function(t){t.forEach(function(t){var i=t.target;f.trackValues&&(t.newValue=n(i).attr(t.attributeName));f.callback.call(i,t)})}),this.each(function(){o.observe(this,e)})):i()?this.on("DOMAttrModified",function(n){n.originalEvent&&(n=n.originalEvent);n.attributeName=n.attrName;n.oldValue=n.prevValue;f.callback.call(this,n)}):"onpropertychange"in document.body?this.on("propertychange",function(t){t.attributeName=window.event.propertyName;r.call(n(this),f.trackValues,t);f.callback.call(this,t)}):this}}(jQuery),function(n){n.eventEmitter={_JQInit:function(){this._JQ=n(this)},emit:function(n,t){this._JQ||this._JQInit();this._JQ.trigger(n,t)},once:function(n,t){this._JQ||this._JQInit();this._JQ.one(n,t)},on:function(n,t){this._JQ||this._JQInit();this._JQ.bind(n,t)},off:function(n,t){this._JQ||this._JQInit();this._JQ.unbind(n,t)}}}(jQuery);var freeboard=function(){function h(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(location.search);return t==null?"":decodeURIComponent(t[1].replace(/\+/g," "))}var i={},r={},t=new FreeboardUI,n=new FreeboardModel(i,r,t),u=new JSEditor,e=new ValueEditor(n),o=new PluginEditor(u,e),s=new DeveloperConsole(n),f={values:{"font-family":'"HelveticaNeue-UltraLight", "Helvetica Neue Ultra Light", "Helvetica Neue", sans-serif',color:"#d3d4d4","font-weight":100}};return ko.bindingHandlers.pluginEditor={init:function(u,f,e,s){var h=ko.unwrap(f()),a={},c=undefined,l="";h.type=="datasource"?(a=i,l="Datasource"):h.type=="widget"?(a=r,l="Widget"):h.type=="pane"&&(l="Pane");$(u).click(function(){var e,f;h.operation=="delete"?(e=$("<p>Are you sure you want to delete this "+l+"?<\/p>"),new DialogBox(e,"Confirm Delete","Yes","No",function(){h.type=="datasource"?n.deleteDatasource(s):h.type=="widget"?n.deleteWidget(s):h.type=="pane"&&n.deletePane(s)})):(f=undefined,h.type=="datasource"?h.operation=="add"?c={}:(f=s.type(),c=s.settings(),c.name=s.name()):h.type=="widget"?h.operation=="add"?c={}:(f=s.type(),c=s.settings()):h.type=="pane"&&(c={},h.operation=="edit"&&(c.title=s.title(),c.col_width=s.col_width()),a={settings:{settings:[{name:"title",display_name:"Title",type:"text"},{name:"col_width",display_name:"Columns",type:"integer",default_value:1,required:!0}]}}),o.createPluginEditor(l,a,f,c,function(f){var e;h.operation=="add"?h.type=="datasource"?(e=new DatasourceModel(n,i),n.addDatasource(e),e.name(f.settings.name),delete f.settings.name,e.settings(f.settings),e.type(f.type)):h.type=="widget"&&(e=new WidgetModel(n,r),e.settings(f.settings),e.type(f.type),s.widgets.push(e),t.attachWidgetEditIcons(u)):h.operation=="edit"&&(h.type=="pane"?(s.title(f.settings.title),s.col_width(f.settings.col_width),t.processResize(!1)):(h.type=="datasource"&&(s.name(f.settings.name),delete f.settings.name),s.type(f.type),s.settings(f.settings)))}))})}},ko.virtualElements.allowedBindings.datasourceTypeSettings=!0,ko.bindingHandlers.datasourceTypeSettings={update:function(n,t,i,r,u){processPluginSettings(n,t,i,r,u)}},ko.bindingHandlers.pane={init:function(i,r,u,f,e){n.isEditing()&&$(i).css({cursor:"pointer"});t.addPane(i,f,e.$root.isEditing())},update:function(i,r,u,f){n.panes.indexOf(f)==-1&&t.removePane(i);t.updatePane(i,f)}},ko.bindingHandlers.widget={init:function(i){n.isEditing()&&t.attachWidgetEditIcons($(i).parent())},update:function(n,t,i,r){r.shouldRender()&&($(n).empty(),r.render(n))}},$(function(){function i(){t.processResize(!0)}t.showLoadingIndicator(!0);var n;$(window).resize(function(){clearTimeout(n);n=setTimeout(i,500)})}),{initialize:function(i,r){ko.applyBindings(n);var u=h("load");u!=""?$.ajax({url:u,success:function(t){n.loadDashboard(t);_.isFunction(r)&&r()}}):(n.allow_edit(i),n.setEditing(i),t.showLoadingIndicator(!1),_.isFunction(r)&&r(),freeboard.emit("initialized"))},newDashboard:function(){n.loadDashboard({allow_edit:!0})},loadDashboard:function(t,i){n.loadDashboard(t,i)},serialize:function(){return n.serialize()},setEditing:function(t,i){n.setEditing(t,i)},isEditing:function(){return n.isEditing()},loadDatasourcePlugin:function(t){_.isUndefined(t.display_name)&&(t.display_name=t.type_name);t.settings.unshift({name:"name",display_name:"Name",type:"text",required:!0});n.addPluginSource(t.source);i[t.type_name]=t;n._datasourceTypes.valueHasMutated()},resize:function(){t.processResize(!0)},loadWidgetPlugin:function(t){_.isUndefined(t.display_name)&&(t.display_name=t.type_name);n.addPluginSource(t.source);r[t.type_name]=t;n._widgetTypes.valueHasMutated()},setAssetRoot:function(n){u.setAssetRoot(n)},addStyle:function(n,t){var r=n+"{"+t+"}",i=$("style#fb-styles");i.length==0&&(i=$('<style id="fb-styles" type="text/css"><\/style>'),$("head").append(i));i[0].styleSheet?i[0].styleSheet.cssText+=r:i.text(i.text()+r)},showLoadingIndicator:function(n){t.showLoadingIndicator(n)},showDialog:function(n,t,i,r,u){new DialogBox(n,t,i,r,u)},getDatasourceSettings:function(t){var r=n.datasources(),i=_.find(r,function(n){return n.name()===t});return i?i.settings():null},setDatasourceSettings:function(t,i){var f=n.datasources(),r=_.find(f,function(n){return n.name()===t}),u;if(!r){console.log("Datasource not found");return}u=_.defaults(i,r.settings());r.settings(u)},getStyleString:function(n){var t="";return _.each(f[n],function(n,i){t=t+i+":"+n+";"}),t},getStyleObject:function(n){return f[n]},showDeveloperConsole:function(){s.showDeveloperConsole()}}}();$.extend(freeboard,jQuery.eventEmitter);
//# sourceMappingURL=freeboard.min.js.map
